#!/bin/sh
set -e

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Backend lint-staged
if [ -f "backend/package.json" ]; then
  echo "[pre-commit] Backend: lint-staged"
  (
    cd backend
    if command -v npx >/dev/null 2>&1; then
      npx lint-staged
    else
      echo "[pre-commit] WARNING: npx not found on host. Skipping lint-staged for backend."
      echo "[pre-commit] To fix linting automatically, please install Node.js on your host"
      echo "[pre-commit] or run 'bash docker/codymatch.sh lint' manually."
    fi
  )
fi

# Frontend lint-staged
if [ -f "frontend/package.json" ]; then
  echo "[pre-commit] Frontend: lint-staged"
  (
    cd frontend
    if command -v npx >/dev/null 2>&1; then
      npx lint-staged
    else
      echo "[pre-commit] WARNING: npx not found on host. Skipping lint-staged for frontend."
    fi
  )
fi

# Root Markdown linting
#STAGED_ROOT_MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^[^/]+\.md$')
#if [ -n "$STAGED_ROOT_MD_FILES" ]; then
#  echo "[pre-commit] Root: markdownlint --fix"
#  if [ -f "backend/node_modules/.bin/markdownlint" ]; then
#      ./backend/node_modules/.bin/markdownlint --fix $STAGED_ROOT_MD_FILES
#      git add $STAGED_ROOT_MD_FILES
#  elif [ -f "frontend/node_modules/.bin/markdownlint" ]; then
#      ./frontend/node_modules/.bin/markdownlint --fix $STAGED_ROOT_MD_FILES
#      git add $STAGED_ROOT_MD_FILES
#  else
#      echo "Warning: markdownlint not found in backend or frontend node_modules. Skipping root files."
#  fi
#fi
