services:
  frontend:
    user: ${USERID}:${GROUPID}
    build:
      context: ${FRONTEND_FOLDER}
      dockerfile: ${FRONTEND_FOLDER}/dev.Dockerfile
      args:
        USERID: ${USERID}
        GROUPID: ${GROUPID}
    ports:
      - "3000:3000"
    volumes:
      - ${FRONTEND_FOLDER}:/usr/app
    stop_grace_period: 0s
  code-runner-image:
    image: docker:cli
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: sh -c "echo 'Pulling Judge0 compilers image...' && docker pull ${CODE_RUNNER_IMAGE:-judge0/compilers:latest} && echo 'âœ“ Code runner image ready'"
    networks:
      - default
    stop_grace_period: 0s
  backend:
    # Run as root initially so entrypoint can fix permissions, then it switches to the user
    build:
      context: ${BACKEND_FOLDER}
      dockerfile: ${BACKEND_FOLDER}/dev.Dockerfile
      args:
        USERID: ${USERID}
        GROUPID: ${GROUPID}
    ports:
      - ${DEBUG_PORT}:9230
      - "3001:3001"
    volumes:
      - ${BACKEND_FOLDER}:/usr/app
      - /var/run/docker.sock:/var/run/docker.sock
      - code_runner_temp:/tmp/code-runner
    depends_on:
      - db
      - frontend
      - code-runner-image
    stop_grace_period: 0s
  db:
    volumes:
      - db_data:/var/lib/postgresql/data
    stop_grace_period: 0s

volumes:
  code_runner_temp:
