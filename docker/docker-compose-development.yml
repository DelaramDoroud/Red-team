services:
  frontend:
    user: ${USERID}:${GROUPID}
    build:
      context: ${FRONTEND_FOLDER}
      dockerfile: ${FRONTEND_FOLDER}/dev.Dockerfile
      args:
        USERID: ${USERID}
        GROUPID: ${GROUPID}
    ports:
      - "3000:3000"
    volumes:
      - ${FRONTEND_FOLDER}:/usr/app
  code-runner-image:
    image: docker:cli
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: sh -c "echo 'Pulling Judge0 compilers image...' && docker pull ${CODE_RUNNER_IMAGE:-judge0/compilers:latest} && echo 'âœ“ Code runner image ready'"
    networks:
      - default
  backend:
    # Run as root initially so entrypoint can fix permissions, then it switches to the user
    build:
      context: ${BACKEND_FOLDER}
      dockerfile: ${BACKEND_FOLDER}/dev.Dockerfile
      args:
        USERID: ${USERID}
        GROUPID: ${GROUPID}
    ports:
      - ${DEBUG_PORT}:9230
      - "3001:3001"
    volumes:
      - ${BACKEND_FOLDER}:/usr/app
      - /var/run/docker.sock:/var/run/docker.sock
      - code_runner_temp:/tmp/code-runner
    environment:
      NODE_ENV: development
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-codymatch}
      DB_USER: ${DB_USER:-codymatch}
      DB_PASSWORD: ${DB_PASSWORD:-codymatch}
      CODE_RUNNER_IMAGE: ${CODE_RUNNER_IMAGE:-judge0/compilers:latest}
      CODE_RUNNER_TEMP_DIR: /tmp/code-runner
      USERID: ${USERID}
      GROUPID: ${GROUPID}
    depends_on:
      - db
      - frontend
      - code-runner-image
  db:
    volumes:
      - db_data:/var/lib/postgresql/data

volumes:
  code_runner_temp:
