services:
  frontend:
    restart: always
    hostname: frontend
    env_file:
      - .env
  code-runner-image:
    image: docker:cli
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: sh -c "echo 'Pulling Judge0 compilers image...' && docker pull ${CODE_RUNNER_IMAGE:-judge0/compilers:latest} && echo 'âœ“ Code runner image ready'"
    networks:
      - default
  backend:
    restart: always
    env_file:
      - .env
    environment:
      WORKDIR: /usr/app
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: codymatch
      DB_USER: codymatch
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://127.0.0.1:3000}
      CODE_RUNNER_IMAGE: ${CODE_RUNNER_IMAGE:-judge0/compilers:latest}
      CODE_RUNNER_TEMP_DIR: /tmp/code-runner
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - code_runner_temp:/tmp/code-runner
    networks:
      - default
    depends_on:
      - db
      - redis
      - frontend
      - code-runner-image
  db:
    image: postgres:16-alpine
    shm_size: "2gb"
    restart: always
    ports:
      - ${DB_PORT}:5432
    environment:
      POSTGRES_DB: codymatch
      POSTGRES_USER: codymatch
      POSTGRES_PASSWORD: ${DB_PASSWORD}
  redis:
    image: redis:7-alpine
    restart: always

volumes:
  db_data:
  code_runner_temp:
